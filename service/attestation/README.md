# Attestation
This project provides attestation service and attestation agent for common attestation scenes.

## Components
- Attestation Agent: An agent depends by relying party or attester for attestation.
- Attestation Service: A verifier verifies TEE evidence.

Note: The roles relying party, attester and verifier is defined in [RFC9334 RATS](https://datatracker.ietf.org/doc/html/rfc9334#name-architectural-overview).

# Quick Start

## Dependencies
- OS: openEuler 24.09
- Repo
```
vim /etc/yum.repos.d/openEuler.repo
[everything]
name=everything
baseurl=http://121.36.84.172/dailybuild/EBS-openEuler-24.09/openeuler-2024-09-03-08-34-41/everything/aarch64/
enabled=1
gpgcheck=0
```

## Build 

### Build AA
```
cd secGear/service/attestation/attestation-agent
cargo build --features virtcca-attester
```

### Build AS
```
cd secGear/service/attestation/attestation-service
cargo build
```


## Run AS, AA and aa-test Demo
### AS
#### Config AS
- Generate as config file
```
mkdir -p /etc/attestation/attestation-service/
vim /etc/attestation.bak/attestation-service/attestation-service.conf
{
        "token_cfg": {
                "key": "/etc/attestation/attestation-service/token/private.pem",
                "iss": "oeas",
                "nbf": 0,
                "valid_duration": 300,
                "alg": "PS256"
        }
}
```
- Generate test private key and self-signed certificate
```
openssl genrsa -out private.pem 2048
openssl req -new -key private.pem -out server.csr
openssl x509 -req -in server.csr -out as_cert.pem -signkey private.pem -days 3650

mkdir -p /etc/attestation/attestation-service/token
cp private.pem /etc/attestation/attestation-service/token

// as_cert.pem will be deployed into AA config directory
```

- Download Huawei root cert chain to verify virtCCA evidence

    [Root Cert](https://download.huawei.com/dl/download.do?actionFlag=download&nid=PKI1000000002&partNo=3001&mid=SUP_PKI)

    [Sub Cert](https://download.huawei.com/dl/download.do?actionFlag=download&nid=PKI1000000040&partNo=3001&mid=SUP_PKI)
```
mkdir -p /etc/attestation/attestation-service/verifier/virtcca

// upload root cert and sub cert to the above directory
```

#### Run AS
```
cd secGear/service/attestation/attestation-service
./target/debug/attestation-service
```
attestation service listens on 127.0.0.1:8080 default, also can specify custom ip:port by -s param such as
```
./target/debug/attestation-service -s ip:port
```

- Config default policy
```
cp secGear/service/attestation/attestation-service/policy/src/opa/default_vcca.rego /etc/attestation/attestation-service/policy
```
- Config virtcca reference

virtcca reference (such as rim:7d2e49c8d29f18b748e658e7243ecf26bc292e5fee93f72af11ad9da9810142a ) is generated by [rim_ref tools](https://gitee.com/openeuler/virtCCA_sdk/tree/master/attestation/rim_ref)
```
curl -H "Content-Type:application/json" -X POST -d '{"refs":"{\"vcca.cvm.rim\":\"7d2e49c8d29f18b748e658e7243ecf26bc292e5fee93f72af11ad9da9810142a\"}"}'  http://127.0.0.1:8080/reference
```

### AA

#### Install attester depends SDK
```
yum install virtCCA_sdk-devel
```
#### Config AA
```
mkdir -p /etc/attestation/attestation-agent/
// svr_url为attestation service的ip和端口，需要根据实际部署网络修改配置
// cert 为attestation service的公钥证书，本demo为在attestation service端手动生成的自签名公钥证书
// iss 为attestation service签发token时的签发者名称
vim /etc/attestation/attestation-agent/attestation-agent.conf
{
    "svr_url": "http://127.0.0.1:8080",
    "token_cfg": {
        "cert": "/etc/attestation/attestation-agent/as_cert.pem",
        "iss": "oeas"
    }
}
```
#### Run AA
```
cd secGear/service/attestation/attestation-agent
./target/debug/attestation-agent
```

### Run AA demo
```
cd secGear/service/attestation/attestation-agent
./target/debug/aa-test
```